{% extends "base.html" %}

{% block title %}æˆ‘çš„åœºåœ° - ç¾¤ç»„åœºåœ°æŠ¥åç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>æˆ‘çš„åœºåœ°</h2>
            <a href="{{ url_for('venue_form') }}" class="btn btn-primary">æŠ¥åæ–°åœºåœ°</a>
        </div>

        {% if venue_submissions %}
            <div class="row">
                {% for submission in venue_submissions %}
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">{{ submission.venue_date|date_format }}</h5>
                                    <p class="mb-0 text-muted">
                                        {% set time_slot_names = [] %}
                                        {% for time_slot in submission.get_time_slots() %}
                                            {% set _ = time_slot_names.append(dict(time_slots)[time_slot]) %}
                                        {% endfor %}
                                        {{ time_slot_names|join('ã€') }}
                                        {% if submission.is_free_submission %}
                                            <span class="badge bg-success ms-2">å…å•</span>
                                        {% endif %}
                                    </p>
                                </div>
                                <span class="badge bg-primary">{{ submission.get_venue_count() }}ä¸ªåœºåœ°</span>
                            </div>
                            <div class="card-body">
                                <!-- Venue Details -->
                                <div class="mb-3">
                                    <strong>åœºåœ°è¯¦æƒ…ï¼š</strong>
                                    <div class="mt-2">
                                        {% for venue in submission.venues|sort(attribute='venue_number') %}
                                            <div class="venue-item mb-2">
                                                <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                                                    <div class="d-flex align-items-center">
                                                        <span class="badge bg-secondary me-2">{{ venue.venue_number }}</span>
                                                        <small class="text-muted">{{ dict(time_slots)[venue.time_slot] }}</small>
                                                        {% if venue.plus_one_name %}
                                                            <small class="text-info ms-2">+{{ venue.plus_one_name }}</small>
                                                        {% endif %}
                                                    </div>
                                                    {% if venue.venue_screenshot %}
                                                        <button class="btn btn-outline-primary btn-sm" 
                                                                onclick="showScreenshot('{{ url_for('static', filename='uploads/' + venue.venue_screenshot) }}', {{ venue.venue_number }})">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Registration Info -->
                                <div class="mb-3">
                                    <p class="mb-1">
                                        <strong>æŠ¥ååç§°ï¼š</strong> {{ submission.registration_name }}
                                    </p>
                                    {% set plus_one_count = submission.get_total_plus_ones() %}
                                    {% if plus_one_count > 0 %}
                                        <p class="mb-1">
                                            <strong>åŒä¼´äººæ•°ï¼š</strong> {{ plus_one_count }}äºº
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="card-footer">
                                <small class="text-muted">
                                    æäº¤æ—¶é—´ï¼š{{ submission.upload_time|datetime }}
                                    {% if submission.is_multi_venue() %}
                                        | å¤šåœºåœ°æŠ¥å
                                    {% endif %}
                                    {% if submission.get_time_slots()|length > 1 %}
                                        | æ··åˆæ—¶é—´æ®µ
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <div class="alert alert-info">
                    <h4>è¿˜æ²¡æœ‰æŠ¥åä»»ä½•åœºåœ°</h4>
                    <p>ç‚¹å‡»"æŠ¥åæ–°åœºåœ°"æŒ‰é’®å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡åœºåœ°æŠ¥åã€‚</p>
                    <a href="{{ url_for('venue_form') }}" class="btn btn-primary">ç«‹å³æŠ¥å</a>
                </div>
            </div>
        {% endif %}

        <!-- åœºåœ°ä½¿ç”¨è¯´æ˜ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h6>
                        <ul class="mb-0 small">
                            <li><strong>å…å•è§„åˆ™ï¼š</strong>è´¡çŒ® {{ config.FREE_VENUE_COUNT }} ä¸ªæˆ–ä»¥ä¸Šåœºåœ°å°†è‡ªåŠ¨æ ‡è®°ä¸ºå…å•</li>
                            <li><strong>æ—¶é—´æ®µï¼š</strong>{{ time_slots|map('last')|join('ã€') }}</li>
                            <li><strong>æ··åˆæ—¶é—´æ®µï¼š</strong>æ¯ä¸ªåœºåœ°å¯ä»¥é€‰æ‹©ä¸åŒçš„æ—¶é—´æ®µ</li>
                            <li><strong>+1åŒä¼´ï¼š</strong>æ¯ä¸ªåœºåœ°å¯ä»¥å•ç‹¬å¸¦ä¸€ä½åŒä¼´</li>
                            <li><strong>æˆªå›¾æŸ¥çœ‹ï¼š</strong>ç‚¹å‡»å›¾ç‰‡æŒ‰é’®å¯æŸ¥çœ‹åœºåœ°æˆªå›¾</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æˆªå›¾æŸ¥çœ‹æ¨¡æ€æ¡† -->
<div class="modal fade" id="screenshotModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="screenshotTitle">åœºåœ°æˆªå›¾</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="screenshotImg" src="" class="img-fluid" alt="åœºåœ°æˆªå›¾">
            </div>
        </div>
    </div>
</div>

<style>
.venue-thumbnail {
    height: 80px;
    object-fit: cover;
    cursor: pointer;
    transition: transform 0.2s;
}

.venue-thumbnail:hover {
    transform: scale(1.05);
}

.badge {
    font-size: 0.75em;
}

.card-footer {
    background-color: rgba(0,0,0,0.03);
}
</style>

<script>
function showScreenshot(imageSrc, venueNumber) {
    document.getElementById('screenshotImg').src = imageSrc;
    document.getElementById('screenshotTitle').textContent = `åœºåœ° ${venueNumber} æˆªå›¾`;
    const modal = new bootstrap.Modal(document.getElementById('screenshotModal'));
    modal.show();
}
</script>
{% endblock %}